# Intended to match and test charts/dataplane/values.aws.yaml
global:
  UNION_CONTROL_PLANE_HOST: "test-controlplane-host"
  CLUSTER_NAME: "test-cluster-name"
  ORG_NAME: "test-org-name"
  CLIENT_ID: "test-client-id"
  METADATA_BUCKET: "test-metadata-bucket"
  FAST_REGISTRATION_BUCKET: "test-fast-registration-bucket"
  AWS_REGION: "test-region"
  BACKEND_IAM_ROLE_ARN: "test-backend-iam-role-arn"
  WORKER_IAM_ROLE_ARN: "test-worker-iam-role-arn"

# ----------------------------------------------------------------------------
# SECTION 2: Core Identity Configuration (REQUIRED)
# ----------------------------------------------------------------------------
# These values reference the globals defined above.

# Cloud provider identifier (do not change for AWS)
provider: aws

# ----------------------------------------------------------------------------
# SECTION 3: Object Storage Configuration (REQUIRED)
# ----------------------------------------------------------------------------
# Configure S3 buckets for workflow metadata and fast registration.
# These buckets must be created before deployment.

storage:
  provider: aws
  authType: iam  # Use IAM roles for pods (IRSA recommended)

  # AWS region for S3 buckets
  region: '{{ .Values.global.AWS_REGION }}'
  enableMultiContainer: true

# ----------------------------------------------------------------------------
# SECTION 4: IAM Roles (REQUIRED for AWS)
# ----------------------------------------------------------------------------
# Configure IRSA (IAM Roles for Service Accounts) for secure AWS access.
# These IAM roles must be created with appropriate trust policies and permissions.

# IAM role for Union backend services (operator, propeller, etc.)
additionalServiceAccountAnnotations:
  eks.amazonaws.com/role-arn: "{{ tpl .Values.global.BACKEND_IAM_ROLE_ARN . }}"

# IAM role for workflow execution pods
userRoleAnnotationKey: eks.amazonaws.com/role-arn
userRoleAnnotationValue: "{{ tpl .Values.global.WORKER_IAM_ROLE_ARN . }}"

# ----------------------------------------------------------------------------
# SECTION 5: Authentication Secrets (REQUIRED)
# ----------------------------------------------------------------------------
# Client credentials for authenticating with the Union control plane.
# These will be provided by the Union team for managed control planes.

secrets:
  admin:
    # Client ID for dataplane authentication
    clientId: '{{ .Values.global.CLIENT_ID }}'

    # Client secret for dataplane authentication (keep this secure!)
    clientSecret: "test-not-real-secret"

    # Whether to create the Kubernetes secret
    # Set to false if you manage secrets externally (e.g., via External Secrets Operator)
    create: true

# ----------------------------------------------------------------------------
# SECTION 6: Logging Configuration (REQUIRED)
# ----------------------------------------------------------------------------
# FluentBit collects and forwards logs to the control plane.

fluentbit:
  serviceAccount:
    name: fluentbit-system
    # Annotations may be required for IRSA
    annotations: {}

# ----------------------------------------------------------------------------
# SECTION 7: Task Level Monitoring
# ----------------------------------------------------------------------------

# DCGM Exporter
dcgm-exporter:
  enabled: true

  # Configure AWS specific affinity
  # Reference: http://github.com/aws-observability/helm-charts/blob/main/charts/amazon-cloudwatch-observability/values.yaml#L1413-L1545
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: node.kubernetes.io/instance-type
                operator: In
                values:
                  ## NVIDIA GPU instance types
                  - g3.4xlarge
                  - g3.8xlarge
                  - g3.16xlarge
                  - g3s.xlarge
                  - g4ad.2xlarge
                  - g4ad.4xlarge
                  - g4ad.8xlarge
                  - g4ad.16xlarge
                  - g4ad.xlarge
                  - g4dn.2xlarge
                  - g4dn.4xlarge
                  - g4dn.8xlarge
                  - g4dn.12xlarge
                  - g4dn.16xlarge
                  - g4dn.metal
                  - g4dn.xlarge
                  - g5.2xlarge
                  - g5.4xlarge
                  - g5.8xlarge
                  - g5.12xlarge
                  - g5.16xlarge
                  - g5.24xlarge
                  - g5.48xlarge
                  - g5.xlarge
                  - g5g.2xlarge
                  - g5g.4xlarge
                  - g5g.8xlarge
                  - g5g.16xlarge
                  - g5g.metal
                  - g5g.xlarge
                  - g6.2xlarge
                  - g6.4xlarge
                  - g6.8xlarge
                  - g6.12xlarge
                  - g6.16xlarge
                  - g6.24xlarge
                  - g6.48xlarge
                  - g6.xlarge
                  - g6e.2xlarge
                  - g6e.4xlarge
                  - g6e.8xlarge
                  - g6e.12xlarge
                  - g6e.16xlarge
                  - g6e.24xlarge
                  - g6e.48xlarge
                  - g6e.xlarge
                  - gr6.4xlarge
                  - gr6.8xlarge
                  - p2.8xlarge
                  - p2.16xlarge
                  - p2.xlarge
                  - p3.2xlarge
                  - p3.8xlarge
                  - p3.16xlarge
                  - p3dn.24xlarge
                  - p4d.24xlarge
                  - p4de.24xlarge
                  - p5.48xlarge
                  - p5e.48xlarge
                  - p5en.48xlarge
                  - ml.g3.4xlarge
                  - ml.g3.8xlarge
                  - ml.g3.16xlarge
                  - ml.g3s.xlarge
                  - ml.g4ad.2xlarge
                  - ml.g4ad.4xlarge
                  - ml.g4ad.8xlarge
                  - ml.g4ad.16xlarge
                  - ml.g4ad.xlarge
                  - ml.g4dn.2xlarge
                  - ml.g4dn.4xlarge
                  - ml.g4dn.8xlarge
                  - ml.g4dn.12xlarge
                  - ml.g4dn.16xlarge
                  - ml.g4dn.metal
                  - ml.g4dn.xlarge
                  - ml.g5.2xlarge
                  - ml.g5.4xlarge
                  - ml.g5.8xlarge
                  - ml.g5.12xlarge
                  - ml.g5.16xlarge
                  - ml.g5.24xlarge
                  - ml.g5.48xlarge
                  - ml.g5.xlarge
                  - ml.g5g.2xlarge
                  - ml.g5g.4xlarge
                  - ml.g5g.8xlarge
                  - ml.g5g.16xlarge
                  - ml.g5g.metal
                  - ml.g5g.xlarge
                  - ml.g6.2xlarge
                  - ml.g6.4xlarge
                  - ml.g6.8xlarge
                  - ml.g6.12xlarge
                  - ml.g6.16xlarge
                  - ml.g6.24xlarge
                  - ml.g6.48xlarge
                  - ml.g6.xlarge
                  - ml.g6e.2xlarge
                  - ml.g6e.4xlarge
                  - ml.g6e.8xlarge
                  - ml.g6e.12xlarge
                  - ml.g6e.16xlarge
                  - ml.g6e.24xlarge
                  - ml.g6e.48xlarge
                  - ml.g6e.xlarge
                  - ml.gr6.4xlarge
                  - ml.gr6.8xlarge
                  - ml.p2.8xlarge
                  - ml.p2.16xlarge
                  - ml.p2.xlarge
                  - ml.p3.2xlarge
                  - ml.p3.8xlarge
                  - ml.p3.16xlarge
                  - ml.p3dn.24xlarge
                  - ml.p4d.24xlarge
                  - ml.p4de.24xlarge
                  - ml.p5.48xlarge
                  - ml.p5e.48xlarge
                  - ml.p5en.48xlarge
              - key: eks.amazonaws.com/compute-type
                operator: NotIn
                values:
                  - fargate

  # -- It's common practice to taint accelerator nodes to ensure non accelerator workloads
  #
  #    tolerations to ensure it only runs on GPU nodes.
  # tolerations: []

# ----------------------------------------------------------------------------
# SECTION 8: Monitoring
# ----------------------------------------------------------------------------

prometheus:

  kubeApiServer:
    enabled: true

  nodeExporter:
    enabled: true

  defaultRules:
    create: true

    rules:
      kubeApiserverAvailability: true
      kubeApiserverBurnrate: true
      kubeApiserverHistogram: true
      kubeApiserverSlos: true
      nodeExporterRecording: true

  grafana:
    enabled: true

    adminUser: "admin"
    adminPassword: "test-not-a-real-password"

    ingress:
      enabled: false

    dashboardProviders:
      dashboardproviders.yaml:
        apiVersion: 1
        providers:
          - name: 'dotdc-kubernetes-dashboards'
            orgId: 1
            folder: 'Kubernetes'
            type: file
            disableDeletion: false
            editable: true
            options:
              path: /var/lib/grafana/dashboards/dotdc-kubernetes-dashboards

    dashboards:
      dotdc-kubernetes-dashboards:
        k8s-system-api-server:
          url: https://raw.githubusercontent.com/dotdc/grafana-dashboards-kubernetes/master/dashboards/k8s-system-api-server.json
          token: ''
        k8s-system-coredns:
          url: https://raw.githubusercontent.com/dotdc/grafana-dashboards-kubernetes/master/dashboards/k8s-system-coredns.json
          token: ''
        k8s-views-global:
          url: https://raw.githubusercontent.com/dotdc/grafana-dashboards-kubernetes/master/dashboards/k8s-views-global.json
          token: ''
        k8s-views-namespaces:
          url: https://raw.githubusercontent.com/dotdc/grafana-dashboards-kubernetes/master/dashboards/k8s-views-namespaces.json
          token: ''
        k8s-views-nodes:
          url: https://raw.githubusercontent.com/dotdc/grafana-dashboards-kubernetes/master/dashboards/k8s-views-nodes.json
          token: ''
        k8s-views-pods:
          url: https://raw.githubusercontent.com/dotdc/grafana-dashboards-kubernetes/master/dashboards/k8s-views-pods.json
          token: ''