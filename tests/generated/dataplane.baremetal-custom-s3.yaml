---
# Source: dataplane/templates/clusterresourcesync/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: clustersync-system
  namespace: union
---
# Source: dataplane/templates/nodeexecutor/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: executor
  namespace: union
  labels:
    app: executor
---
# Source: dataplane/templates/nodeexecutor/webhook.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: union-pod-webhook
  namespace: union
---
# Source: dataplane/templates/operator/serviceaccount-proxy.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: proxy-system
  labels:
    app.kubernetes.io/name: operator-proxy
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
---
# Source: dataplane/templates/operator/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: operator-system
  labels:
    app.kubernetes.io/name: union-operator
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
---
# Source: dataplane/templates/common/auth-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: union-secret-auth
  namespace: union
type: Opaque
data:
  # TODO(rob): update or configure operator to use client_secret like all the other components.
  app_secret: ZHVtbXktc2VjcmV0LXZhbHVl
  client_secret: ZHVtbXktc2VjcmV0LXZhbHVl
---
# Source: dataplane/templates/common/cluster-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: operator-cluster-name
type: Opaque
data:
  cluster_name: dW5pb24tYWNtZQ==
---
# Source: dataplane/templates/nodeexecutor/webhook.yaml
# prevent duplicate from propeller

# Create an empty secret that the first propeller pod will populate
apiVersion: v1
kind: Secret
metadata:
  name: union-pod-webhook #prevent name collision with flyte oss
  namespace: union
type: Opaque
---
# Source: dataplane/templates/clusterresourcesync/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: flyte-clusterresourcesync-config
  namespace: union
  labels:
    app.kubernetes.io/name: clusterresourcesync
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
data:
  cluster_resources.yaml: | 
    cluster_resources:
      clusterName: 'union-acme'
      customData:
      - production:
        - projectQuotaCpu:
            value: "4096"
        - projectQuotaMemory:
            value: 2Ti
        - projectQuotaNvidiaGpu:
            value: "256"
        - defaultUserRoleKey:
            value: ''
        - defaultUserRoleValue:
            value: ''
      - staging:
        - projectQuotaCpu:
            value: "4096"
        - projectQuotaMemory:
            value: 2Ti
        - projectQuotaNvidiaGpu:
            value: "256"
        - defaultUserRoleKey:
            value: ''
        - defaultUserRoleValue:
            value: ''
      - development:
        - projectQuotaCpu:
            value: "4096"
        - projectQuotaMemory:
            value: 2Ti
        - projectQuotaNvidiaGpu:
            value: "256"
        - defaultUserRoleKey:
            value: ''
        - defaultUserRoleValue:
            value: ''
      refreshInterval: 5m
      standaloneDeployment: true
      templatePath: /etc/flyte/clusterresource/templates
    clusterResourcesPrivate:
      app:
        isServerless: false
    union:
      auth:
        authorizationMetadataKey: flyte-authorization
        clientId: 'acme-union-acme-operator'
        clientSecretLocation: /etc/union/secret/client_secret
        tokenRefreshWindow: 5m
        type: ClientSecret
      connection:
        host: dns:///acme.eu-west-2.unionai.cloud
  admin.yaml: | 
    admin:
      clientId: 'acme-union-acme-operator'
      clientSecretLocation: /etc/union/secret/client_secret
      endpoint: dns:///acme.eu-west-2.unionai.cloud
      insecure: false
    event:
      capacity: 1000
      rate: 500
      type: admin
  domain.yaml: | 
    domains:
    - id: development
      name: development
    - id: staging
      name: staging
    - id: production
      name: production
  namespace_config.yaml: | 
    namespace_mapping:
      template: '{{`{{ project }}`}}'
  clusters.yaml: |
    clusters:
      clusterConfigs: []
      labelClusterMap: {}
  logger.yaml: |
    logger:
      level: 4
      show-source: true
  namespace_mapping.yaml: |
    namespace_mapping:
      template: '{{ project }}'
---
# Source: dataplane/templates/clusterresourcesync/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: clusterresource-template
  namespace: union
  labels:
    app.kubernetes.io/name: clusterresourcesync
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
data:
  a_namespace.yaml: | 
    apiVersion: v1
    kind: Namespace
    metadata:
      name: {{ namespace }}
      labels:
        union.ai/namespace-type: flyte
    spec:
      finalizers:
      - kubernetes
    
  b_default_service_account.yaml: | 
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: default
      namespace: {{ namespace }}
      annotations:
        {{ defaultUserRoleKey }}: {{ defaultUserRoleValue }}
    
  c_project_resource_quota.yaml: | 
    apiVersion: v1
    kind: ResourceQuota
    metadata:
      name: project-quota
      namespace: {{ namespace }}
    spec:
      hard:
        limits.cpu: {{ projectQuotaCpu }}
        limits.memory: {{ projectQuotaMemory }}
        requests.nvidia.com/gpu: {{ projectQuotaNvidiaGpu }}
---
# Source: dataplane/templates/imagebuilder/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name : union-operator-buildkit
data:
  buildkitd.toml: |
    debug = false

    [log]
      format = "text"

    [worker.oci]
      enabled = true
      snapshotter = "auto"
      gc = true
      max-parallelism = 0

      # Should not be used if Policies are defined
      gckeepstorage = "10%"
      [[worker.oci.gcpolicy]]
        # Remove COPY/ADD and git checkout files
        keepBytes = "10%"
        keepDuration = "24h"
        filters = [ "type==source.local", "type==source.git.checkout" ]
      [[worker.oci.gcpolicy]]
        # Remove locally cached image layers after it's unused for 24 hours
        keepBytes = "10%"
        keepDuration = "24h"
        filters = [ "regular" ]
      [[worker.oci.gcpolicy]]
        # Remove shared cache mounts. E.G. Pip cache
        keepBytes = "10%"
        keepDuration = "72h"
        filters = [ "type==exec.cachemount" ]
      [[worker.oci.gcpolicy]]
        # Remove everything else to keep the cache size under total file system limit
        all = true
        keepBytes = "80%"
---
# Source: dataplane/templates/nodeexecutor/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: executor
  namespace: union
  labels:
    app: executor
data:
  task_logs.yaml: | 
    plugins:
      logs:
        cloudwatch-enabled: false
        kubernetes-enabled: false
        templates:
        - displayName: Grafana Logs
          templateUris:
          - https://grafana-infra.example.internal/explore?schemaVersion=1&panes=%7B%22pane%22%3A%7B%22datasource%22%3A%22af4lu074kfcaoc%22%2C%22queries%22%3A%5B%7B%22refId%22%3A%22A%22%2C%22expr%22%3A%22%7Bnamespace%3D%5C%22{{ .namespace }}%5C%22%2Cpod%3D%5C%22{{ .podName }}%5C%22%7D%22%2C%22queryType%22%3A%22range%22%2C%22datasource%22%3A%7B%22type%22%3A%22loki%22%2C%22uid%22%3A%22af4lu074kfcaoc%22%7D%2C%22editorMode%22%3A%22code%22%2C%22direction%22%3A%22backward%22%7D%5D%2C%22range%22%3A%7B%22from%22%3A%22{{ .podUnixStartTime }}000%22%2C%22to%22%3A%22now%22%7D%2C%22panelsState%22%3A%7B%22logs%22%3A%7B%22columns%22%3A%7B%220%22%3A%22Line%22%7D%2C%22visualisationType%22%3A%22logs%22%2C%22labelFieldName%22%3A%22labels%22%2C%22refId%22%3A%22A%22%7D%7D%2C%22compact%22%3Afalse%7D%7D&orgId=1
  enabled_plugins.yaml: |
    tasks:
      task-plugins:
        default-for-task-types:
          actor: fast-task
          container: container
          container_array: k8s-array
          sidecar: sidecar
        enabled-plugins:
        - container
        - sidecar
        - k8s-array
        - echo
        - fast-task
        - connector-service
  config.yaml: |
    executor:
      cluster: 'union-acme'
      evaluatorCount: 64
      maxActions: 2000
      organization: 'acme'
      unionAuth:
        injectSecret: true
        secretName: EAGER_API_KEY
      workerName: worker1
      task_resources:
        defaults:
          cpu: 100m
          memory: 500Mi
        limits:
          cpu: 4096
          gpu: 256
          memory: 2Ti
    union:
      connection:
        host: dns:///acme.eu-west-2.unionai.cloud
      auth:
        authorizationMetadataKey: flyte-authorization
        clientId: 'acme-union-acme-operator'
        clientSecretLocation: /etc/union/secret/client_secret
        tokenRefreshWindow: 5m
        type: ClientSecret
    admin:
      clientId: 'acme-union-acme-operator'
      clientSecretLocation: /etc/union/secret/client_secret
      endpoint: dns:///acme.eu-west-2.unionai.cloud
      insecure: false
    authorizer:
      type: noop
    catalog-cache:
      cache-endpoint: dns:///acme.eu-west-2.unionai.cloud
      endpoint: dns:///acme.eu-west-2.unionai.cloud
      insecure: false
      type: fallback
      use-admin-auth: true
    logger:
      level: 4
      show-source: true
    namespace_mapping:
      template: '{{ project }}'
    sharedService:
      metrics:
        scope: 'executor:'
      security:
        allowCors: true
        allowLocalhostAccess: true
        allowedHeaders:
        - Content-Type
        allowedOrigins:
        - '*'
        secure: false
        useAuth: false
    propeller:
      node-config:
        disable-input-file-writes: true
        persist-cache-status: true
    plugins:
      fasttask:
        additional-worker-args:
        - --last-ack-grace-period-seconds
        - "120"
        callback-uri: http://unionai-dataplane-executor.union.svc.cluster.local:15605
        grace-period-status-not-found: 2m
      ioutils:
        remoteFileOutputPaths:
          deckFilename: report.html
      k8s:
        disable-inject-owner-references: true
        default-cpus: 100m
        default-env-vars: []
        default-memory: 100Mi
        co-pilot:
          image: 'cr.flyte.org/flyteorg/flytecopilot:v1.14.1'
          name: flyte-copilot-
          start-timeout: 30s
    storage:
      container: "union"
      stow:
        config:
          access_key_id: dummy-secret-value
          auth_type: accesskey
          disable_force_path_style: "true"
          disable_ssl: false
          endpoint: https://s3.example.com
          region: RNO2A
          secret_key: dummy-secret-value
        kind: s3
      type: stow
      enable-multicontainer: false
      limits:
        maxDownloadMBs: 1024
      cache:
        max_size_mbs: 0
        target_gc_percent: 70
---
# Source: dataplane/templates/operator/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: union-operator
  labels:
    app.kubernetes.io/name: union-operator
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
data:
  k8s.yaml: | 
    plugins:
      k8s:
        default-cpus: 100m
        default-env-vars: []
        default-memory: 100Mi
  config.yaml: |
    union:
      connection:
        host: dns:///acme.eu-west-2.unionai.cloud
      auth:
        authorizationMetadataKey: flyte-authorization
        clientId: 'acme-union-acme-operator'
        clientSecretLocation: /etc/union/secret/client_secret
        tokenRefreshWindow: 5m
        type: ClientSecret
    sharedService:
      features:
        gatewayV2: true
      port: 8081
    authorizer:
      type: noop
    operator:
      enabled: true
      enableTunnelService: true
      tunnel:
        enableDirectToAppIngress: false
        deploymentToRestart: union-operator-proxy
      apps:
        enabled: 'false'
      syncClusterConfig:
        enabled: false
      clusterId:
        organization: 'acme'
      clusterData:
        appId: 'acme-union-acme-operator'
        bucketName: 'union'
        bucketRegion: 'RNO2A'
        cloudHostName: 'acme.eu-west-2.unionai.cloud'
        gcpProjectId: ''
        metadataBucketPrefix: 's3://union'
        userRole: ''
        userRoleKey: ''
        # -- storageType is only used when syncClusterConfig is enabled. It is intentionally disabled and it should not be used.
        storageType: custom
        customStorageConfig: |
          stow:
            config:
              access_key_id: dummy-secret-value
              auth_type: accesskey
              disable_force_path_style: "true"
              disable_ssl: false
              endpoint: https://s3.example.com
              region: RNO2A
              secret_key: dummy-secret-value
            kind: s3
          type: stow
      collectUsages:
        enabled: true
      billableUsageCollector:
        enabled: true
      dependenciesHeartbeat:
        prometheus:
          endpoint: 'http://union-operator-prometheus:80/-/healthy'
        proxy:
          endpoint: 'http://union-operator-proxy:10254'
      imageBuilder:
        enabled: true
        executionNamespaceLabels:
          union.ai/namespace-type: flyte
        referenceConfigmapName: union-operator
        targetConfigMapName: "build-image-config"
    proxy:
      imageBuilderConfig:
        authenticationType: 'noop'
        defaultRepository: 'ghcr.io/acme-corp/acme/union'
      persistedLogs:
        objectStore:
          pathTemplate: namespace-{{.KubernetesNamespace}}.pod-{{.KubernetesPodName}}.cont-{{.KubernetesContainerName}}
          prefix: persisted-logs
        sourceType: ObjectStore
      smConfig:
        enabled: 'true'
        k8sConfig:
          namespace: 'union'
        type: 'K8s'
  logger.yaml: |
    logger:
      level: 4
      show-source: true
  config-overrides.yaml: | 
    cache:
      identity:
        enabled: false
  storage.yaml: | 
    storage:
      container: "union"
      stow:
        config:
          access_key_id: dummy-secret-value
          auth_type: accesskey
          disable_force_path_style: "true"
          disable_ssl: false
          endpoint: https://s3.example.com
          region: RNO2A
          secret_key: dummy-secret-value
        kind: s3
      type: stow
      enable-multicontainer: false
      limits:
        maxDownloadMBs: 1024
      cache:
        max_size_mbs: 0
        target_gc_percent: 70
  fast_registration_storage.yaml: | 
    fastRegistrationStorage:
      container: "union"
      stow:
        config:
          access_key_id: dummy-secret-value
          auth_type: accesskey
          disable_force_path_style: "true"
          disable_ssl: false
          endpoint: https://s3.example.com
          region: RNO2A
          secret_key: dummy-secret-value
        kind: s3
      type: stow
  image-builder.buildkit-uri: "tcp://union-operator-buildkit.union.svc.cluster.local:1234"
  image-builder.default-repository: "ghcr.io/acme-corp/acme/union"
  image-builder.authentication-type: "noop"
---
# Source: dataplane/templates/propeller/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: flyte-propeller-webhook-config
  namespace: union
data:
  core.yaml: |

    
    webhook:
      certDir: /etc/webhook/certs
      embeddedSecretManagerConfig:
        imagePullSecrets:
          enabled: true
        k8sConfig:
          namespace: 'union'
        type: 'K8s'
      listenPort: '9443'
      localCert: true
      secretManagerTypes:
      - Embedded
      - K8s
      secretName: union-pod-webhook
      serviceName: union-pod-webhook
      servicePort: '443'
---
# Source: dataplane/templates/clusterresourcesync/serviceaccount.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: clustersync-resource
rules:
  - apiGroups:
      - ""
      - rbac.authorization.k8s.io
    resources:
      - configmaps
      - namespaces
      - pods
      - resourcequotas
      - roles
      - rolebindings
      - secrets
      - services
      - serviceaccounts
      - clusterrolebindings
    verbs:
      - '*'
---
# Source: dataplane/templates/nodeexecutor/serviceaccount.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: union-executor
  labels:
    app: executor
rules:
# Allow RO access to PODS
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
  - list
  - watch
# Allow Event recording access
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - update
  - delete
  - patch
# Allow Access All plugin objects
- apiGroups:
  - '*'
  resources:
  - '*'
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - delete
  - patch
# Allow Access to CRD
- apiGroups:
  - apiextensions.k8s.io
  resources:
  - customresourcedefinitions
  verbs:
  - get
  - list
  - watch
  - create
  - delete
  - update
---
# Source: dataplane/templates/nodeexecutor/webhook.yaml
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: union-union-pod-webhook
  namespace: union
rules:
  - apiGroups:
      - "*"
    resources:
      - mutatingwebhookconfigurations
      - secrets
      - pods
      - replicasets/finalizers
    verbs:
      - get
      - create
      - update
      - patch
---
# Source: dataplane/templates/operator/serviceaccount-proxy.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: proxy-system
  labels:
    app.kubernetes.io/name: operator-proxy
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
rules:
  - apiGroups:
      - '*'
    resources:
      - events
      - flyteworkflows
      - pods/log
      - pods
      - rayjobs
      - resourcequotas
    verbs:
      - get
      - list
      - watch
---
# Source: dataplane/templates/operator/serviceaccount.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: operator-system
  labels:
    app.kubernetes.io/name: union-operator
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
rules:
  # Allow Access to all resources under flyte.lyft.com
  - apiGroups:
      - flyte.lyft.com
    resources:
      - flyteworkflows
      - flyteworkflows/finalizers
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - delete
      - patch
      - post
      - deletecollection
  - apiGroups:
      - '*'
    resources:
      - resourcequotas
      - pods
      - configmaps
      - podtemplates
      - secrets
      - namespaces
      - nodes
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - delete
  - nonResourceURLs:
      - /metrics
    verbs:
      - get
---
# Source: dataplane/templates/clusterresourcesync/serviceaccount.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: clustersync-resource
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: clustersync-resource
subjects:
  - kind: ServiceAccount
    name: clustersync-system
    namespace: union
---
# Source: dataplane/templates/clusterresourcesync/serviceaccount.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: clustersync-auth-delegator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:auth-delegator
subjects:
  - kind: ServiceAccount
    name: clustersync-system
    namespace: union
---
# Source: dataplane/templates/nodeexecutor/serviceaccount.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: union-executor
  labels:
    app: executor
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: union-executor
subjects:
- kind: ServiceAccount
  name: executor
  namespace: union
---
# Source: dataplane/templates/nodeexecutor/webhook.yaml
# Create a binding from Role -> ServiceAccount
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: union-union-pod-webhook
  namespace: union
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: union-union-pod-webhook
subjects:
  - kind: ServiceAccount
    name: union-pod-webhook
    namespace: union
---
# Source: dataplane/templates/operator/serviceaccount-proxy.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: proxy-system
  labels:
    app.kubernetes.io/name: operator-proxy
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: proxy-system
subjects:
  - kind: ServiceAccount
    name: proxy-system
    namespace: union
---
# Source: dataplane/templates/operator/serviceaccount.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: operator-system
  labels:
    app.kubernetes.io/name: union-operator
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: operator-system
subjects:
  - kind: ServiceAccount
    name: operator-system
    namespace: union
---
# Source: dataplane/templates/operator/serviceaccount-proxy-secret.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: proxy-system-secret
  namespace: union
  labels:
    app.kubernetes.io/name: operator-proxy
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
rules:
  - apiGroups:
      - '*'
    resources:
      - secrets
    verbs:
      - get
      - list
      - create
      - update
      - delete
---
# Source: dataplane/templates/operator/serviceaccount.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: operator-system
  labels:
    app.kubernetes.io/name: union-operator
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
rules:
  - apiGroups:
      - '*'
    resources:
      - secrets
      - deployments
    verbs:
      - get
      - list
      - watch
      - create
      - update
---
# Source: dataplane/templates/operator/serviceaccount-proxy-secret.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: proxy-system-secret
  namespace: union
  labels:
    app.kubernetes.io/name: operator-proxy
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: proxy-system-secret
subjects:
  - kind: ServiceAccount
    name: proxy-system
    namespace: union
---
# Source: dataplane/templates/operator/serviceaccount.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: operator-system
  labels:
    app.kubernetes.io/name: union-operator
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: operator-system
subjects:
  - kind: ServiceAccount
    name: operator-system
    namespace: union
---
# Source: dataplane/templates/imagebuilder/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: union-operator-buildkit
  labels:
    app.kubernetes.io/name: imagebuilder-buildkit
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 1234
      targetPort: tcp
      protocol: TCP
      name: tcp
  selector:
    app.kubernetes.io/name: imagebuilder-buildkit
    app.kubernetes.io/instance: release-name
---
# Source: dataplane/templates/nodeexecutor/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: release-name-dataplane-executor
  labels:
    app: executor
spec:
  type: ClusterIP
  ports:
    - port: 15605
      targetPort: 15605
      protocol: TCP
      name: fasttask
  selector:
    app: executor
---
# Source: dataplane/templates/nodeexecutor/webhook.yaml
apiVersion: v1
kind: Service
metadata:
  name: union-pod-webhook
  namespace: union
  labels:
    app.kubernetes.io/name: flyte-pod-webhook
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
  annotations:
    projectcontour.io/upstream-protocol.h2c: grpc
spec:
  selector:
    app.kubernetes.io/name: flyte-pod-webhook
    app.kubernetes.io/instance: release-name
  ports:
    - name: https
      protocol: TCP
      port: 443
      targetPort: 9443
    - name: debug
      protocol: TCP
      port: 10254
      targetPort: 10254
---
# Source: dataplane/templates/operator/service-proxy.yaml
apiVersion: v1
kind: Service
metadata:
  name: union-operator-proxy
  labels:
    app.kubernetes.io/name: operator-proxy
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: http
      protocol: TCP
      name: http
    - port: 10254
      targetPort: debug
      protocol: TCP
      name: debug
  selector:
    app.kubernetes.io/name: operator-proxy
    app.kubernetes.io/instance: release-name
---
# Source: dataplane/templates/operator/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: union-operator
  labels:
    app.kubernetes.io/name: union-operator
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: debug
      protocol: TCP
      name: debug
  selector:
    app.kubernetes.io/name: union-operator
    app.kubernetes.io/instance: release-name
---
# Source: dataplane/templates/clusterresourcesync/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: syncresources
  namespace: union
  labels:
    app.kubernetes.io/name: clusterresourcesync
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: clusterresourcesync
      app.kubernetes.io/instance: release-name
  template:
    metadata:
      annotations:
        configChecksum: "1dc62f3e23cb7a9ae96048da779d508c803352db29b947635e0a343846fd11e"
        
      labels:
        
        app.kubernetes.io/name: clusterresourcesync
        app.kubernetes.io/instance: release-name
        platform.union.ai/service-group: release-name
        app.kubernetes.io/managed-by: Helm
    spec:
      containers:
        - command:
            - clusterresource
            - --config
            - /etc/flyte/config/*.yaml
            - clusterresource
            - run
          env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: POD_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          - name: GOMEMLIMIT
            valueFrom:
              resourceFieldRef:
                divisor: 1
                resource: limits.memory
          - name: GOMAXPROCS
            valueFrom:
              resourceFieldRef:
                divisor: 1
                resource: limits.cpu
          - name: CLUSTER_NAME
            valueFrom:
              secretKeyRef:
                name: operator-cluster-name
                key: cluster_name
          - name: DEPLOYMENT_NAME
            value: operator
          - name: PROXY_SERVICE_URL
            value: http://union-operator-proxy:8080
          - name: PROMETHEUS_SERVICE_URL
            value: http://union-operator-prometheus:80
          - name: KNATIVE_PROXY_SERVICE_URL
            value: http://kourier-internal
          image: "public.ecr.aws/p0i0a9q8/unionoperator:2026.2.10"
          imagePullPolicy: "IfNotPresent"
          name: sync-cluster-resources
          resources:
            limits:
              cpu: "1"
              memory: 500Mi
            requests:
              cpu: 500m
              memory: 100Mi
          volumeMounts:
            - name: auth
              mountPath: /etc/union/secret
            - name: resource-templates
              mountPath: /etc/flyte/clusterresource/templates
            - name: config-volume
              mountPath: /etc/flyte/config
          ports:
            - containerPort: 10254
      serviceAccountName: clustersync-system
      volumes:
        - configMap:
            name: clusterresource-template
          name: resource-templates
        - configMap:
            name: flyte-clusterresourcesync-config
          name: config-volume
        - name: auth
          secret:
            secretName: union-secret-auth
---
# Source: dataplane/templates/imagebuilder/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: union-operator-buildkit
  labels:
    app.kubernetes.io/name: imagebuilder-buildkit
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
spec:
  strategy:
    type: Recreate
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: imagebuilder-buildkit
      app.kubernetes.io/instance: release-name
  template:
    metadata:
      annotations:
        container.apparmor.security.beta.kubernetes.io/buildkit: unconfined
      labels:
        app.kubernetes.io/name: imagebuilder-buildkit
        app.kubernetes.io/instance: release-name
    spec:
      containers:
        - name: "buildkit"
          image: "moby/buildkit:buildx-stable-1-rootless"
          imagePullPolicy: IfNotPresent
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: GOMEMLIMIT
              valueFrom:
                resourceFieldRef:
                  divisor: 1
                  resource: limits.memory
            - name: GOMAXPROCS
              valueFrom:
                resourceFieldRef:
                  divisor: 1
                  resource: limits.cpu
            - name: CLUSTER_NAME
              valueFrom:
                secretKeyRef:
                  name: operator-cluster-name
                  key: cluster_name
            - name: DEPLOYMENT_NAME
              value: operator
            - name: PROXY_SERVICE_URL
              value: http://union-operator-proxy:8080
            - name: PROMETHEUS_SERVICE_URL
              value: http://union-operator-prometheus:80
            - name: KNATIVE_PROXY_SERVICE_URL
              value: http://kourier-internal
          volumeMounts:
            - mountPath: /home/user/.local/share/buildkit
              name: buildkitd
            - mountPath: /etc/buildkit
              name: buildkit-config
          args:
            - --config
            - /etc/buildkit/buildkitd.toml
            - --addr
            - unix:///run/user/1000/buildkit/buildkitd.sock
            - --addr
            - tcp://0.0.0.0:1234
            - --oci-worker-no-process-sandbox
          ports:
            - name: tcp
              containerPort: 1234
              protocol: TCP
          readinessProbe:
            exec:
              command:
              - buildctl
              - debug
              - workers
            initialDelaySeconds: 5
            periodSeconds: 30
          livenessProbe:
            exec:
              command:
              - buildctl
              - debug
              - workers
            initialDelaySeconds: 5
            periodSeconds: 30
          securityContext:
            seccompProfile: # Needs Kubernetes >= 1.19
              type: Unconfined
            runAsUser: 1000
            runAsGroup: 1000
          resources:
            requests:
              cpu: 1
              ephemeral-storage: 20Gi
              memory: 1Gi
      volumes:
      - name: buildkitd
        emptyDir: {}
      - configMap:
          name: union-operator-buildkit
        name: buildkit-config
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                app.kubernetes.io/name: imagebuilder-buildkit
                app.kubernetes.io/instance: release-name
            topologyKey: "kubernetes.io/hostname"
---
# Source: dataplane/templates/nodeexecutor/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: executor
  namespace: union
  labels:
    app: executor
spec:
  replicas: 1
  selector:
    matchLabels:
      app: executor
  template:
    metadata:
      annotations:
        configChecksum: "e518d56c53e8fa3869ac11dfbc7fc2b8624fc18fd51d0fdd30a2ab23688b7b4"
      labels:
        
        app: executor
    spec:
      securityContext:
        fsGroup: 1337
      serviceAccountName: executor
      volumes:
        - name: config-volume
          configMap:
            name: executor
        - name: secret-volume
          secret:
            secretName: union-secret-auth
        - name: auth
          secret:
            secretName: union-secret-auth
      containers:
        - name: executor
          image: "public.ecr.aws/p0i0a9q8/unionoperator:2026.2.10"
          imagePullPolicy: IfNotPresent
          command:
            - executor
            - serve
            - --config
            - /etc/config/*.yaml
          ports:
            - name: http
              containerPort: 8089
              protocol: TCP
            - name: metrics
              containerPort: 10254
              protocol: TCP
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: GOMEMLIMIT
              valueFrom:
                resourceFieldRef:
                  divisor: 1
                  resource: limits.memory
            - name: GOMAXPROCS
              valueFrom:
                resourceFieldRef:
                  divisor: 1
                  resource: limits.cpu
            - name: CLUSTER_NAME
              valueFrom:
                secretKeyRef:
                  name: operator-cluster-name
                  key: cluster_name
            - name: DEPLOYMENT_NAME
              value: operator
            - name: PROXY_SERVICE_URL
              value: http://union-operator-proxy:8080
            - name: PROMETHEUS_SERVICE_URL
              value: http://union-operator-prometheus:80
            - name: KNATIVE_PROXY_SERVICE_URL
              value: http://kourier-internal
          resources:
            limits:
              cpu:    "4"
              memory: "8Gi"
            requests:
              cpu:    "1"
              memory: "1Gi"
          volumeMounts:
            - name: config-volume
              mountPath: /etc/config
            - name: secret-volume
              mountPath: /etc/union/secret
            - name: auth
              mountPath: /etc/secrets/
---
# Source: dataplane/templates/nodeexecutor/webhook.yaml
# Create the actual deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: union-pod-webhook
  namespace: union
  labels:
    app.kubernetes.io/name: flyte-pod-webhook
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: flyte-pod-webhook
      app.kubernetes.io/instance: release-name
  template:
    metadata:
      labels:
        
        app.kubernetes.io/name: flyte-pod-webhook
        app.kubernetes.io/instance: release-name
        platform.union.ai/service-group: release-name
        app.kubernetes.io/managed-by: Helm
      annotations:
        configChecksum: "c2eae24d5c6dab188e17e69073e32f53362cc05825a11857bc7919316944f59"
        
    spec:
      securityContext:
        fsGroup: 65534
        fsGroupChangePolicy: Always
        runAsNonRoot: true
        runAsUser: 1001
        seLinuxOptions:
          type: spc_t
      serviceAccountName: union-pod-webhook
      initContainers:
        - name: generate-secrets
          image: "public.ecr.aws/p0i0a9q8/unionoperator:2026.2.10"
          imagePullPolicy: "IfNotPresent"
          command:
            - flytepropeller
          args:
            - webhook
            - init-certs
            - --config
            - /etc/flyte/config/*.yaml
          env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: POD_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          - name: GOMEMLIMIT
            valueFrom:
              resourceFieldRef:
                divisor: 1
                resource: limits.memory
          - name: GOMAXPROCS
            valueFrom:
              resourceFieldRef:
                divisor: 1
                resource: limits.cpu
          - name: CLUSTER_NAME
            valueFrom:
              secretKeyRef:
                name: operator-cluster-name
                key: cluster_name
          - name: DEPLOYMENT_NAME
            value: operator
          - name: PROXY_SERVICE_URL
            value: http://union-operator-proxy:8080
          - name: PROMETHEUS_SERVICE_URL
            value: http://union-operator-prometheus:80
          - name: KNATIVE_PROXY_SERVICE_URL
            value: http://kourier-internal
          volumeMounts:
            - name: config-volume
              mountPath: /etc/flyte/config
            - name: webhook-certs
              mountPath: /etc/webhook/certs
          resources:
            limits:
              cpu: 1
              ephemeral-storage: 500Mi
              memory: 500Mi
            requests:
              cpu: 200m
              ephemeral-storage: 500Mi
              memory: 500Mi
      containers:
        - name: webhook
          image: "public.ecr.aws/p0i0a9q8/unionoperator:2026.2.10"
          imagePullPolicy: "IfNotPresent"
          command:
            - flytepropeller
          args:
            - webhook
            - --config
            - /etc/flyte/config/*.yaml
          env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: POD_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          - name: GOMEMLIMIT
            valueFrom:
              resourceFieldRef:
                divisor: 1
                resource: limits.memory
          - name: GOMAXPROCS
            valueFrom:
              resourceFieldRef:
                divisor: 1
                resource: limits.cpu
          - name: CLUSTER_NAME
            valueFrom:
              secretKeyRef:
                name: operator-cluster-name
                key: cluster_name
          - name: DEPLOYMENT_NAME
            value: operator
          - name: PROXY_SERVICE_URL
            value: http://union-operator-proxy:8080
          - name: PROMETHEUS_SERVICE_URL
            value: http://union-operator-prometheus:80
          - name: KNATIVE_PROXY_SERVICE_URL
            value: http://kourier-internal
          ports:
            - containerPort: 9443
            - containerPort: 10254
          resources:
            limits:
              cpu: 1
              ephemeral-storage: 500Mi
              memory: 500Mi
            requests:
              cpu: 200m
              ephemeral-storage: 500Mi
              memory: 500Mi
          volumeMounts:
            - name: config-volume
              mountPath: /etc/flyte/config
              readOnly: true
            - name: webhook-certs
              mountPath: /etc/webhook/certs
              readOnly: true
      volumes:
        - name: config-volume
          configMap:
            name: flyte-propeller-webhook-config
        - name: webhook-certs
          emptyDir: {}
---
# Source: dataplane/templates/operator/deployment-proxy.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: union-operator-proxy
  namespace: union
  labels:
    app.kubernetes.io/name: operator-proxy
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: operator-proxy
      app.kubernetes.io/instance: release-name
  template:
    metadata:
      annotations:
        configChecksum: "13fb60edb107e058cee34471d9ccc99d6a7e9a9e1b257965cd4aa9c11a26a7c"
        
      labels:
        
        app.kubernetes.io/name: operator-proxy
        app.kubernetes.io/instance: release-name
        platform.union.ai/service-group: release-name
        app.kubernetes.io/managed-by: Helm
    spec:
      volumes:
        - name: config-volume
          projected:
            sources:
            - configMap:
                name: union-operator
            - configMap:
                name: flyte-clusterresourcesync-config
        - name: secret-volume
          secret:
            secretName: union-secret-auth
      serviceAccountName: proxy-system
      securityContext:
        {}
      containers:
        - name: operator-proxy
          securityContext:
            {}
          image: "public.ecr.aws/p0i0a9q8/unionoperator:2026.2.10"
          imagePullPolicy: IfNotPresent
          terminationMessagePolicy: FallbackToLogsOnError
          resources:
            limits:
              cpu: "3"
              memory: 3Gi
            requests:
              cpu: 500m
              memory: 500Mi
          volumeMounts:
            - mountPath: /etc/union/config
              name: config-volume
            - mountPath: /etc/union/secret
              name: secret-volume
          args:
            - operator
            - proxy
            - --config
            - /etc/union/config/*.yaml
          ports:
            - name: http
              containerPort: 8089
              protocol: TCP
            - name: connect
              containerPort: 8080
              protocol: TCP
            - name: grpc
              containerPort: 8081
              protocol: TCP
            - name: debug
              containerPort: 10254
              protocol: TCP
          env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: POD_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          - name: GOMEMLIMIT
            valueFrom:
              resourceFieldRef:
                divisor: 1
                resource: limits.memory
          - name: GOMAXPROCS
            valueFrom:
              resourceFieldRef:
                divisor: 1
                resource: limits.cpu
          - name: CLUSTER_NAME
            valueFrom:
              secretKeyRef:
                name: operator-cluster-name
                key: cluster_name
          - name: DEPLOYMENT_NAME
            value: operator
          - name: PROXY_SERVICE_URL
            value: http://union-operator-proxy:8080
          - name: PROMETHEUS_SERVICE_URL
            value: http://union-operator-prometheus:80
          - name: KNATIVE_PROXY_SERVICE_URL
            value: http://kourier-internal
        - name: "tunnel"
          securityContext:
            {}
          image: "public.ecr.aws/p0i0a9q8/unionoperator:2026.2.10"
          imagePullPolicy: IfNotPresent
          args:
            - cloudflared
            - tunnel
            - --no-autoupdate
            - run
            - --token
            - $(TUNNEL_TOKEN)
          env:
            - name: TUNNEL_TOKEN
              valueFrom:
                secretKeyRef:
                  name: union-secret-auth
                  key: tunnel_token
                  optional: true
          resources:
            limits:
              cpu: "3"
              memory: 3Gi
            requests:
              cpu: 500m
              memory: 500Mi
---
# Source: dataplane/templates/operator/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: union-operator
  labels:
    app.kubernetes.io/name: union-operator
    app.kubernetes.io/instance: release-name
    platform.union.ai/service-group: release-name
    app.kubernetes.io/managed-by: Helm
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: union-operator
      app.kubernetes.io/instance: release-name
  template:
    metadata:
      annotations:
        configChecksum: "13fb60edb107e058cee34471d9ccc99d6a7e9a9e1b257965cd4aa9c11a26a7c"
        
      labels:
        
        app.kubernetes.io/name: union-operator
        app.kubernetes.io/instance: release-name
        platform.union.ai/service-group: release-name
        app.kubernetes.io/managed-by: Helm
    spec:
      serviceAccountName: operator-system
      securityContext:
        {}
      volumes:
        - name: config-volume
          configMap:
            name: union-operator
        - name: secret-volume
          secret:
            secretName: union-secret-auth
      containers:
        - name: operator
          securityContext:
            {}
          image: "public.ecr.aws/p0i0a9q8/unionoperator:2026.2.10"
          imagePullPolicy: IfNotPresent
          terminationMessagePolicy: FallbackToLogsOnError
          resources:
            limits:
              cpu: "2"
              memory: 3Gi
            requests:
              cpu: "1"
              memory: 1Gi
          volumeMounts:
            - mountPath: /etc/union/config
              name: config-volume
            - mountPath: /etc/union/secret
              name: secret-volume
          env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: POD_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          - name: GOMEMLIMIT
            valueFrom:
              resourceFieldRef:
                divisor: 1
                resource: limits.memory
          - name: GOMAXPROCS
            valueFrom:
              resourceFieldRef:
                divisor: 1
                resource: limits.cpu
          - name: CLUSTER_NAME
            valueFrom:
              secretKeyRef:
                name: operator-cluster-name
                key: cluster_name
          - name: DEPLOYMENT_NAME
            value: operator
          - name: PROXY_SERVICE_URL
            value: http://union-operator-proxy:8080
          - name: PROMETHEUS_SERVICE_URL
            value: http://union-operator-prometheus:80
          - name: KNATIVE_PROXY_SERVICE_URL
            value: http://kourier-internal
          args:
            - operator
            - serve
            - --config
            - /etc/union/config/*.yaml
            - --operator.clusterId.name
            - "$(CLUSTER_NAME)"
            - --operator.tunnel.k8sSecretName
            - union-secret-auth
          ports:
            - name: grpc
              containerPort: 8080
              protocol: TCP
            - name: http
              containerPort: 8089
              protocol: TCP
            - name: debug
              containerPort: 10254
              protocol: TCP
---
# Source: dataplane/templates/propeller/serviceaccount.yaml
---
