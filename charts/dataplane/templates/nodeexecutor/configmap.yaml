{{- if .Values.executor.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: executor
  namespace: {{ .Release.Namespace }}
  labels:
    app: executor
data:
  {{- with .Values.executor.task_logs }}
  task_logs.yaml: | {{ tpl (toYaml .) $ | nindent 4 }}
  {{- end }}
  enabled_plugins.yaml: |
    {{- with .Values.config.enabled_plugins }}
    {{- tpl (toYaml .) $ | nindent 4 }}
    {{- end }}
  config.yaml: |
    {{- with .Values.executor.config }}
    executor:
      {{- toYaml . | nindent 6 }}
    {{- end }}
    {{- with .Values.config.task_resource_defaults -}}
    {{ toYaml . | nindent 6 }}
    {{- end }}
    union:
      connection:
        host: {{ .Values.host }}
      auth:
        type: ClientSecret
        clientId: {{ .Values.secrets.admin.clientId }}
        clientSecretLocation: /etc/union/secret/app_secret
        authorizationMetadataKey: "flyte-authorization"
        tokenRefreshWindow: 5m
    admin:
      endpoint: {{ .Values.host }}
      clientId: {{ .Values.secrets.admin.clientId }}
      clientSecretLocation: /etc/secrets/client_secret
      insecure: false
    authorizer:
      type: noop
    catalog-cache:
      cache-endpoint: {{ .Values.host }}
      insecure: false
      max-cache-age: 360h
      type: cacheservicev2
      use-admin-auth: true
    logger:
      level: {{ .Values.config.logger.level }}
      show-source: true
    sharedService:
      metrics:
        scope: "executor:"
      security:
        secure: false
        useAuth: false
        allowCors: true
        allowedOrigins:
          # Accepting all domains for Sandbox installation
          - "*"
        allowedHeaders:
          - "Content-Type"
        allowLocalhostAccess: true
    propeller:
      node-config:
        disable-input-file-writes: true
    plugins:
      ioutils:
        remoteFileOutputPaths:
          deckFilename: report.html
      # -- Configuration section for all K8s specific plugins [Configuration structure](https://pkg.go.dev/github.com/lyft/flyteplugins/go/tasks/pluginmachinery/flytek8s/config)
      fasttask:
        additional-worker-args:
          - "--last-ack-grace-period-seconds"
          - "120"
        callback-uri: "http://unionai-dataplane-executor.{{.Release.Namespace}}.svc.cluster.local:15605"
        grace-period-status-not-found: 2m
      k8s:
        disable-inject-owner-references: true
{{- with .Values.config.k8s.plugins.k8s }}
{{ tpl (toYaml .) $ | indent 8 }}
{{- end }}
{{- with .Values.config.copilot.plugins.k8s }}
{{ tpl (toYaml .) $ | indent 8 }}
{{- end }}
    {{- tpl (include "storage" .) $ | nindent 4 }}
{{- end }}